<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VTCLB · Балансер</title>
  <link rel="stylesheet" href="balancer.css">
  <link rel="stylesheet" href="styles/balance.css">
  <style>
    :root {
      --bg: #111;
      --card: #1b1b1b;
      --primary: #00b140;
      --text: #eee;
      --muted: #aaa;
      --secondary: #222;
      --border: #2a2a2a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--secondary); padding: 14px 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.4); position: sticky; top: 0; z-index: 20; }
    .topbar { display: flex; align-items: center; gap: 12px; justify-content: space-between; max-width: 1200px; margin: 0 auto; }
    .mode-switch { display: flex; gap: 8px; }
    button { border: none; cursor: pointer; font-weight: 600; border-radius: 8px; transition: transform 120ms ease, box-shadow 120ms ease; }
    button:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .btn { padding: 10px 14px; background: var(--card); color: var(--text); border: 1px solid var(--border); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 6px 18px rgba(0,177,64,0.35); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); }
    .btn:hover { transform: translateY(-1px); }
    main { max-width: 1200px; margin: 24px auto 64px; padding: 0 16px; display: grid; gap: 18px; }
    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.5px; }
    h2 { margin: 8px 0 12px; font-size: 18px; }
    h3 { margin: 8px 0; font-size: 16px; color: var(--muted); }
    label { color: var(--muted); font-size: 13px; display: block; margin-bottom: 6px; }
    select, input, textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #101010; color: var(--text); font-size: 14px; }
    textarea { resize: vertical; min-height: 80px; }
    .grid { display: grid; gap: 14px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .table { width: 100%; border-collapse: collapse; background: #101010; border-radius: 10px; overflow: hidden; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    .table th { background: #141414; color: var(--muted); font-weight: 600; font-size: 13px; }
    .table tbody tr:hover { background: rgba(255,255,255,0.03); }
    .badge { background: rgba(0,177,64,0.15); color: var(--primary); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .section-title { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 180px; }
    .teams { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .team-card { padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: #141414; }
    .team-card h4 { margin: 0 0 8px; }
    .team-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }
    .team-list li { background: #0f0f0f; border: 1px solid var(--border); padding: 8px 10px; border-radius: 8px; display: flex; justify-content: space-between; }
    .muted { color: var(--muted); font-size: 13px; }
    .mode-panel { display: none; }
    .mode-panel.active { display: block; }
    .pill { padding: 8px 10px; background: #0f0f0f; border: 1px solid var(--border); border-radius: 10px; }
    .checkbox-row { display: flex; align-items: center; gap: 8px; color: var(--text); }
    .avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
    .table .avatar-cell { display: flex; align-items: center; gap: 8px; }
    .metrics { display: flex; gap: 10px; flex-wrap: wrap; color: var(--muted); font-size: 13px; }
    .tag { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 4px 8px; border-radius: 8px; }
    /* Modal */
    #avatar-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 9999; }
    #avatar-modal.active { display: flex; }
    .modal-card { width: min(520px, 90vw); background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
    .modal-close { position: absolute; top: 12px; right: 12px; background: transparent; color: var(--text); font-size: 22px; width: 32px; height: 32px; line-height: 24px; }
    @media (max-width: 720px) {
      .row { flex-direction: column; }
      header { position: static; }
      main { margin-top: 12px; }
    }
  </style>
</head>
<body data-app-mode="regular">
  <header>
    <div class="topbar">
      <h1>VTCLB · Балансер</h1>
      <div class="mode-switch" id="mode-switch">
        <button class="btn btn-primary" data-mode="regular">Regular</button>
        <button class="btn" data-mode="tournament">Tournament</button>
      </div>
    </div>
  </header>

  <main id="tournament-mode">
    <section class="mode-panel active regular-only" id="regular-panel">
      <div id="ui-panel">
        <div class="panel">
          <div class="section-title">
            <h2>Стандартний балансер</h2>
            <div class="bal__actions">
              <button class="btn" id="ui-burger" aria-label="Меню">☰</button>
            </div>
          </div>
          <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap;">
            <div class="row-inline" style="flex:1 1 240px;">
              <label for="league">Ліга</label>
              <select id="league" class="select-lg">
                <option value="kids">Kids</option>
                <option value="sundaygames">Sunday Games</option>
                <option value="olds">Olds</option>
              </select>
            </div>
            <div class="bal__actions" style="flex:2 1 320px;">
              <button class="btn-primary btn" id="btn-load">Завантажити гравців</button>
              <button class="btn" id="btn-auto">Автобаланс</button>
              <button class="btn" id="btn-manual">Ручний режим</button>
              <select id="teamsize" class="select-lg" aria-label="Кількість команд">
                <option value="2" selected>2 команди</option>
                <option value="3">3 команди</option>
                <option value="4">4 команди</option>
              </select>
            </div>
          </div>
          <div class="row-inline" style="gap:12px; align-items:center; flex-wrap:wrap;">
            <div class="metrics" style="flex:2;">
              <span class="tag">Лоббі: <span id="lobby-count">0</span></span>
              <span class="tag">Σ <span id="lobby-sum">0</span></span>
              <span class="tag">Avg <span id="lobby-avg">0</span></span>
            </div>
            <button class="btn" id="btn-clear-lobby">Очистити лоббі</button>
          </div>
        </div>

        <div id="players" class="page-wrap">
          <section id="sec-player-picker" class="panel open">
            <div class="section-title">
              <h3>Список гравців</h3>
              <div class="bal__actions">
                <input id="player-search" placeholder="Пошук гравців" aria-label="Пошук" />
                <button class="btn" id="btn-sort-name">A → Я</button>
                <button class="btn" id="btn-sort-pts">PTS</button>
              </div>
            </div>
            <div id="select-area">
              <div id="player-list" class="list"></div>
              <div class="bal__actions">
                <button class="btn-primary btn" id="add-to-lobby">Додати в лоббі</button>
                <button class="btn" id="btn-add-selected" aria-label="Додати вибраних">→</button>
                <button class="btn" id="btn-clear-selected">Очистити вибір</button>
              </div>
            </div>
            <div class="bal__row">
              <input id="addPlayerInput" placeholder="Додати гравця по ніку" />
              <button class="btn" id="addPlayerBtn">Додати</button>
            </div>
            <div class="bal__row">
              <input id="new-nick" placeholder="Новий нік" />
              <input id="new-age" type="number" min="0" placeholder="Вік" />
              <button class="btn" id="btn-create">Створити гравця</button>
            </div>
          </section>

          <section class="panel" id="lobby-area">
            <h3>Лоббі</h3>
            <div id="lobby-list" class="lobby-list"></div>
          </section>

          <section class="panel hidden" id="scenario-area">
            <div class="section-title">
              <h3>Команди</h3>
              <div class="team-buttons">
                <button class="btn" data-teams="2">2</button>
                <button class="btn" data-teams="3">3</button>
                <button class="btn" data-teams="4">4</button>
              </div>
            </div>
            <div id="lobby" class="lobby-teams">
              <div id="teams-area" class="lobby-teams"></div>
            </div>
            <div id="arena-select" class="panel" style="margin-top:12px;">
              <h4>Обрати команди для бою</h4>
              <div id="arena-checkboxes" class="lobby-list"></div>
              <button class="btn-primary btn" id="btn-start-match" disabled>Почати бій</button>
            </div>
            <div id="arena-area" class="panel hidden" style="margin-top:12px;">
              <h4 id="arena-vs">Арена</h4>
              <div id="arena-rounds" class="rounds-grid"></div>
              <div class="bal__row">
                <input id="mvp1" list="players-datalist" placeholder="MVP" />
                <input id="mvp2" list="players-datalist" placeholder="2 місце" />
                <input id="mvp3" list="players-datalist" placeholder="3 місце" />
              </div>
              <input id="penalty" placeholder="Штрафи (nick:delta,...)" />
              <div class="bal__actions arena-actions">
                <input type="file" id="pdf-upload" accept="application/pdf" class="pdf-input" />
                <button class="btn" id="btn-parse-pdf">Імпорт PDF</button>
              </div>
              <div class="bal__actions arena-actions">
                <button class="btn-primary btn" id="btn-save-match">Зберегти гру</button>
                <button class="btn" id="btn-clear-arena">Скинути арену</button>
              </div>
            </div>
          </section>
        </div>
      </div>
      <datalist id="players-datalist"></datalist>
    </section>
    <div id="ui-overlay" hidden></div>
    <button id="ui-clear-lobby" class="hidden" aria-hidden="true"></button>

    <section class="panel mode-panel tournament-only" id="tournament-panel">
      <div class="section-title">
        <h2>Турнірний режим</h2>
        <div class="row">
          <div>
            <label for="tournament-league">Ліга</label>
            <select id="tournament-league">
              <option value="kids">Kids</option>
              <option value="olds">Olds</option>
              <option value="sundaygames">Старша ліга</option>
            </select>
          </div>
          <div class="row" style="flex:2; gap:8px; align-items:flex-end;">
            <button class="btn-primary btn" id="tournament-load">Завантажити лоббі</button>
            <button class="btn" id="tournament-reload-lobby">Reload lobby</button>
            <button class="btn" id="tournament-reload-state">Reload tournament data</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="gap:12px; align-items:flex-end;">
          <div>
            <label for="tournament-select">Турнір</label>
            <select id="tournament-select"></select>
          </div>
          <div class="row" style="flex:2; gap:8px; align-items:flex-end;">
            <input id="tournament-name" placeholder="Нова назва турніру">
            <button class="btn" id="tournament-create">Створити</button>
            <button class="btn" id="tournament-refresh">Оновити список</button>
          </div>
        </div>
      </div>

      <div class="panel" style="padding:0; margin-top:12px;">
        <div class="section-title" style="padding:16px;">
          <h3>Лоббі турніру</h3>
          <div class="row" style="flex:2;">
            <input id="tournament-lobby-search" placeholder="Пошук" aria-label="Пошук турнір">
            <div class="row" style="gap:6px;">
              <button class="btn" data-sort="nick">Sort by Nick</button>
              <button class="btn" data-sort="pts">Sort by PTS</button>
              <button class="btn" data-sort="rank">Sort by Rank</button>
              <button class="btn" data-sort="games">Sort by Games</button>
            </div>
            <button class="btn" id="tournament-add-pool">Add to Pool</button>
            <button class="btn" id="tournament-clear">Очистити</button>
          </div>
        </div>
        <div class="tournament-lobby">
          <table class="table" id="tournament-lobby-table">
            <thead>
              <tr><th><input type="checkbox" id="tournament-lobby-select-all" aria-label="Виділити всіх"></th><th>Гравець</th><th>PTS</th><th>Ігор</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <div class="row">
          <div>
            <label for="tournament-team-count">Кількість команд</label>
            <select id="tournament-team-count">
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="row" style="flex:2; gap:8px; align-items:flex-end;">
            <button class="btn-primary btn" id="tournament-auto">Автобаланс</button>
            <button class="btn" id="tournament-save-teams">Зберегти команди</button>
            <button class="btn" id="tournament-clear-teams">Очистити команди</button>
          </div>
        </div>
        <label>Пул гравців</label>
        <div id="tournament-pool" class="pill" style="min-height:44px; display:flex; flex-wrap:wrap; gap:8px;"></div>
        <textarea id="tournament-player-pool" class="tournament-only" placeholder="Ніки через кому" style="margin-top:8px;"></textarea>
        <div class="teams" id="tournament-teams-wrap"></div>
      </div>

      <div class="panel">
        <h3>Режими матчів</h3>
        <div class="row" style="gap:16px;">
          <label class="checkbox-row"><input type="checkbox" class="mode-check" value="DM" checked> DM</label>
          <label class="checkbox-row"><input type="checkbox" class="mode-check" value="KT" checked> KT</label>
          <label class="checkbox-row"><input type="checkbox" class="mode-check" value="TR" checked> TR</label>
        </div>
        <div class="row" style="margin-top:12px; gap:12px; align-items:flex-end;">
          <div>
            <label for="tournament-bestof">Матчів за режимом</label>
            <input id="tournament-bestof" type="number" value="1" min="1" max="5" aria-label="Кількість матчів на режим">
          </div>
          <button class="btn-primary btn" id="tournament-generate">Згенерувати матчі</button>
        </div>
        <div id="tournament-games-list" class="games-list"></div>
        <div class="row" style="margin-top:12px;">
          <select id="tournament-game-select"></select>
        </div>
        <div class="result-panel">
          <div class="result-options" id="tournament-result-buttons">
            <button class="btn" data-result="A">Перемога команди A</button>
            <button class="btn" data-result="DRAW">Нічия</button>
            <button class="btn" data-result="B">Перемога команди B</button>
          </div>
          <div class="grid grid-2">
            <div>
              <label for="t-mvp">MVP</label>
              <select id="t-mvp"></select>
            </div>
            <div>
              <label for="t-second">2 місце</label>
              <select id="t-second"></select>
            </div>
            <div>
              <label for="t-third">3 місце</label>
              <select id="t-third"></select>
            </div>
          </div>
          <div class="row" style="margin-top:12px; gap:8px;">
            <label class="checkbox-row" style="flex:1;"><input type="checkbox" id="t-export-regular"> Експорт як звичайну гру</label>
            <button class="btn-primary btn" id="tournament-save-game">Зберегти результат</button>
            <button class="btn" id="tournament-refresh-data">Оновити</button>
          </div>
          <p id="tournament-game-status" class="muted"></p>
        </div>
        <div id="tournament-match" class="grid grid-2" style="margin-top:12px;"></div>
      </div>
    </section>
  </main>

  <div id="avatar-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <button class="modal-close" id="close-avatar" aria-label="Закрити">×</button>
      <h3>Зміна аватара</h3>
      <p class="muted">Керуйте аватарами гравців. Завантажуйте PNG/JPG до 2 МБ.</p>
      <div class="row">
        <div>
          <label for="avatar-league">Ліга</label>
          <select id="avatar-league">
            <option value="kids">Kids</option>
            <option value="olds">Olds</option>
          </select>
        </div>
        <div>
          <label for="avatar-nick">Нік</label>
          <input id="avatar-nick" placeholder="Введіть нік">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <input type="file" id="avatar-file" accept="image/*">
        <button class="btn-primary btn" id="avatar-upload">Завантажити</button>
      </div>
      <p id="avatar-status" class="muted"></p>
    </div>
  </div>

  <script src="scripts/toast.js"></script>
  <script type="module" src="scripts/config.js"></script>
  <script type="module" src="scripts/logger.js"></script>
  <script type="module" src="scripts/api.js"></script>
  <script type="module" src="scripts/balanceUtils.js"></script>
  <script type="module" src="scripts/main.js?v=2025-09-19-avatars-2"></script>
  <script type="module" src="scripts/arena.js?v=2025-09-19-avatars-2"></script>
  <script type="module" src="scripts/tournamentMode.js"></script>
  <script type="module" src="scripts/balance.js"></script>
</body>
</html>
