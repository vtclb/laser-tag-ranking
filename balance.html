<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–∞–ª–∞–Ω—Å–µ—Ä –∫–æ–º–∞–Ω–¥</title>
  <link rel="stylesheet" href="balancer.css">
</head>
<body>
  <header class="header">
    <div class="logo">üéÆ Game Balancer</div>
    <nav class="nav">
      <button id="btn-load">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≥—Ä–∞–≤—Ü—ñ–≤</button>
      <select id="league">
        <option value="kids">–ú–æ–ª–æ–¥—à–∞ –ª—ñ–≥–∞</option>
        <option value="sunday">–°—Ç–∞—Ä—à–∞ –ª—ñ–≥–∞</option>
      </select>
    </nav>
  </header>

  <main class="container">
    <!-- 1. –í–∏–±—ñ—Ä –≥—Ä–∞–≤—Ü—ñ–≤ -->
    <section id="select-area" class="card hidden">
      <h2>–í–∏–±—ñ—Ä –≥—Ä–∞–≤—Ü—ñ–≤</h2>
      <div class="sort-controls">
        <button id="btn-sort-name">–ê‚Äì–Ø</button>
        <button id="btn-sort-pts">–ó–∞ –±–∞–ª–∞–º–∏ ‚Üì</button>
      </div>
      <ul id="select-list" class="list"></ul>
      <div class="actions">
        <button id="btn-add-selected">–î–æ–¥–∞—Ç–∏ —É –ª–æ–±–±—ñ</button>
        <button id="btn-clear-selected">–û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—ñ—Ä</button>
      </div>
    </section>

    <!-- 2. –õ–æ–±–±—ñ -->
    <section id="lobby-area" class="card hidden">
      <h2>–õ–æ–±–±—ñ –¥–Ω—è</h2>
      <p>–ì—Ä–∞–≤—Ü—ñ–≤: <span id="lobby-count">0</span> | –°—É–º–∞: <span id="lobby-sum">0</span> | –°–µ—Ä–µ–¥–Ω—ñ–π: <span id="lobby-avg">0</span></p>
      <ul id="lobby-list" class="list"></ul>
    </section>

    <!-- 3. –°—Ü–µ–Ω–∞—Ä—ñ–π -->
    <section id="scenario-area" class="card hidden">
      <h2>–†–µ–∂–∏–º –≥—Ä–∏</h2>
      <label for="teamsize">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–º–∞–Ω–¥:</label>
      <select id="teamsize">
        <option value="2">2 –∫–æ–º–∞–Ω–¥–∏</option>
        <option value="3">3 –∫–æ–º–∞–Ω–¥–∏</option>
        <option value="4">4 –∫–æ–º–∞–Ω–¥–∏</option>
      </select>
      <div class="actions">
        <button id="btn-auto">–ê–≤—Ç–æ-–±–∞–ª–∞–Ω—Å</button>
        <button id="btn-manual">–†—É—á–Ω–µ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è</button>
      </div>
    </section>

    <!-- 4. –ö–æ–º–∞–Ω–¥–∏ -->
    <section id="teams-area" class="grid hidden"></section>

    <!-- 5. –ê—Ä–µ–Ω–∞ -->
    <section id="arena-area" class="card hidden">
      <h2>–ê—Ä–µ–Ω–∞: <span id="arena-vs"></span></h2>
      <div id="arena-rounds" class="rounds-grid"></div>
      <div class="actions">
        <button id="btn-save-match" disabled>–ó–±–µ—Ä–µ–≥—Ç–∏ –≥—Ä—É</button>
        <button id="btn-clear-arena">–°–∫–∏–Ω—É—Ç–∏ –∞—Ä–µ–Ω—É</button>
      </div>
    </section>
  </main>

  <script>
  (function(){
    const proxyUrl = 'https://laser-proxy.vartaclub.workers.dev';
    // --- DOM ---
    const btnLoad      = document.getElementById('btn-load');
    const leagueSel    = document.getElementById('league');
    const selectArea   = document.getElementById('select-area');
    const selectList   = document.getElementById('select-list');
    const btnSortName  = document.getElementById('btn-sort-name');
    const btnSortPts   = document.getElementById('btn-sort-pts');
    const btnAddSel    = document.getElementById('btn-add-selected');
    const btnClearSel  = document.getElementById('btn-clear-selected');
    const lobbyArea    = document.getElementById('lobby-area');
    const lobbyList    = document.getElementById('lobby-list');
    const lobbyCount   = document.getElementById('lobby-count');
    const lobbySum     = document.getElementById('lobby-sum');
    const lobbyAvg     = document.getElementById('lobby-avg');
    const scenarioArea = document.getElementById('scenario-area');
    const btnAuto      = document.getElementById('btn-auto');
    const btnManual    = document.getElementById('btn-manual');
    const teamSizeSel  = document.getElementById('teamsize');
    const teamsArea    = document.getElementById('teams-area');
    const arenaArea    = document.getElementById('arena-area');
    const arenaVS      = document.getElementById('arena-vs');
    const arenaRounds  = document.getElementById('arena-rounds');
    const btnSaveMatch = document.getElementById('btn-save-match');
    const btnClearArena= document.getElementById('btn-clear-arena');

    // --- –î–∞–Ω—ñ ---
    let players = [], selected = [], lobby = [], teams = {}, manualCount = 0;

    // --- –£—Ç–∏–ª—ñ—Ç–∏ ---
    function sortByName(a){ return [...a].sort((x,y)=>x.nick.localeCompare(y.nick)); }
    function sortByPts(a){ return [...a].sort((x,y)=>y.pts - x.pts); }

    // --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ---
    async function loadPlayers(league){
      const res = await fetch(`${proxyUrl}?league=${league}&t=${Date.now()}`);
      const txt = await res.text();
      return txt.trim().split('\n').slice(1).filter(l=>l).map(line=>{
        const [,,nick,pts] = line.split(',');
        const p = { nick: nick.trim(), pts: +pts||0 };
        p.rank = p.pts<200?'D':p.pts<500?'C':p.pts<800?'B':p.pts<1200?'A':'S';
        return p;
      });
    }

    // --- –†–µ–Ω–¥–µ—Ä Select ---
    function renderSelect(arr){
      selectArea.classList.remove('hidden');
      lobbyArea.classList.add('hidden');
      selectList.innerHTML = arr.map((p,i)=>`
        <li>
          <label>
            <input type="checkbox" data-i="${i}" ${lobby.includes(p)?'disabled':''}>
            ${p.nick} (${p.pts}) ‚Äì ${p.rank}
          </label>
        </li>
      `).join('');
      selectList.querySelectorAll('input').forEach(cb=>{
        cb.onchange = ()=>{
          const p = arr[+cb.dataset.i];
          if(cb.checked) selected.push(p);
          else selected = selected.filter(x=>x!==p);
        };
      });
    }

    // --- –†–µ–Ω–¥–µ—Ä Lobby ---
    function renderLobby(){
      selectArea.classList.add('hidden');
      lobbyArea.classList.remove('hidden');
      lobbyList.innerHTML = lobby.map((p,i)=>{
        let btns='';
        for(let k=1;k<=manualCount;k++){
          btns += `<button class="assign" data-i="${i}" data-team="${k}">‚Üí${k}</button>`;
        }
        return `<li>${p.nick} (${p.pts}) ‚Äì ${p.rank}${btns}</li>`;
      }).join('');
      const sum = lobby.reduce((s,p)=>s+p.pts,0);
      lobbyCount.textContent = lobby.length;
      lobbySum.textContent   = sum;
      lobbyAvg.textContent   = lobby.length? (sum/lobby.length).toFixed(1):0;
    }

    // --- Init Lobby ---
    function initLobby(pl){
      players = pl; selected=[]; lobby=[]; manualCount=0;
      renderSelect(players);
    }

    // --- Init Scenario ---
    function initScenario(){
      scenarioArea.classList.remove('hidden');
    }

    // --- Render Teams ---
    function renderTeams(N, data){
      teamsArea.classList.remove('hidden');
      arenaArea.classList.add('hidden');
      teamsArea.innerHTML = '';
      teams = {};
      for(let k=1;k<=N;k++){
        teams[k] = data[k] ? [...data[k]] : [];
        const sum = teams[k].reduce((s,p)=>s+p.pts,0);
        const box = document.createElement('div');
        box.className = `card team-box team-${k}`;
        box.innerHTML = `
          <label>
            <input type="checkbox" class="team-select" data-team="${k}">
            –ö–æ–º–∞–Ω–¥–∞ ${k} (‚àë ${sum})
          </label>
          <ul>${teams[k].map(p=>`<li class="rank-${p.rank}">${p.nick} (${p.pts})</li>`).join('')}</ul>
        `;
        teamsArea.append(box);
      }
    }

    // --- Start Match ---
    function startMatch(){
      const sel = [...document.querySelectorAll('.team-select:checked')];
      if(sel.length!==2){ alert('–í–∏–±–µ—Ä—ñ—Ç—å 2 –∫–æ–º–∞–Ω–¥–∏'); return; }
      const [a,b]=sel.map(cb=>+cb.dataset.team);
      arenaVS.textContent = `–ö–æ–º–∞–Ω–¥–∞ ${a} ‚úï –ö–æ–º–∞–Ω–¥–∞ ${b}`;
      arenaArea.classList.remove('hidden');
      arenaRounds.innerHTML = '';
      for(let i=1;i<=3;i++){
        const d = document.createElement('div');
        d.innerHTML = `
          <h4>–†–∞—É–Ω–¥ ${i}</h4>
          <label><input type="checkbox" class="r${i}-a"> T${a}</label>
          <label><input type="checkbox" class="r${i}-b"> T${b}</label>
        `;
        arenaRounds.append(d);
      }
      btnSaveMatch.disabled = false;
    }

    // --- Save Match ---
    async function saveMatch(){
      const vs = arenaVS.textContent.match(/\d+/g).map(n=>+n);
      let wA=0,wB=0;
      for(let i=1;i<=3;i++){
        if(arenaRounds.querySelector(`.r${i}-a`).checked) wA++;
        if(arenaRounds.querySelector(`.r${i}-b`).checked) wB++;
      }
      const winner = wA>wB?`team${vs[0]}`:wB>wA?`team${vs[1]}`:'tie';
      const series = `${wA}-${wB}`;
      await fetch(proxyUrl, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
          league: leagueSel.value,
          team1: teams[vs[0]].map(p=>p.nick).join(', '),
          team2: teams[vs[1]].map(p=>p.nick).join(', '),
          winner, mvp:'', series, penalties:''
        })
      });
      alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
      clearArena();
    }

    // --- Clear Arena ---
    function clearArena(){
      arenaArea.classList.add('hidden');
      arenaRounds.innerHTML='';
      document.querySelectorAll('.team-select').forEach(cb=>cb.checked=false);
      btnSaveMatch.disabled=true;
    }

    // --- Auto-Balance & Manual ---
    function autoBalance(){
      const N = +teamSizeSel.value;
      manualCount=N;
      const arr = N===2
        ? (()=>{
            const half = Math.floor(lobby.length/2);
            const sorted = [...lobby].sort((a,b)=>b.pts-a.pts);
            return [sorted.slice(0,half), sorted.slice(half)];
          })()
        : (()=>{
            const per = Math.ceil(lobby.length/N);
            const sorted = [...lobby].sort((a,b)=>b.pts-a.pts);
            const out=[]; for(let i=0;i<N;i++) out.push(sorted.slice(i*per,(i+1)*per));
            return out;
          })();
      const data = {}; arr.forEach((t,i)=>data[i+1]=t);
      renderTeams(N,data);
    }
    function manualForm(){
      const N = +teamSizeSel.value;
      manualCount=N;
      renderTeams(N,{});
    }

    // --- Assign from Lobby ---
    function assignFromLobby(e){
      if(!e.target.matches('.assign')) return;
      const i = +e.target.dataset.i;
      const t = +e.target.dataset.team;
      const p = lobby.splice(i,1)[0];
      teams[t].push(p);
      renderLobby();
      renderTeams(manualCount, teams);
    }

    // --- Events ---
    btnLoad.onclick = async ()=>{
      const pl = await loadPlayers(leagueSel.value);
      initLobby(pl);
      initScenario();
    };
    btnSortName.onclick = ()=>renderSelect(sortByName(players));
    btnSortPts.onclick  = ()=>renderSelect(sortByPts(players));
    btnAddSel.onclick   = ()=>{
      selected.forEach(p=>{ if(!lobby.includes(p)) lobby.push(p); });
      selected=[];
      renderLobby();
    };
    btnClearSel.onclick = ()=>{ selected=[]; renderSelect(players); };
    lobbyList.addEventListener('click', assignFromLobby);
    btnAuto.onclick   = autoBalance;
    btnManual.onclick = manualForm;
    document.getElementById('btn-start-match').onclick = startMatch;
    btnSaveMatch.onclick = saveMatch;
    btnClearArena.onclick = clearArena;
  })();
  </script>
</body>
</html>
