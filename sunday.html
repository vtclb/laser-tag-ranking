<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ä—à–∞ –õ—ñ–≥–∞ | –õ–∞–∑–µ—Ä—Ç–∞–≥</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; padding:0;
               background: url('assets/backgr.jpg') no-repeat center center fixed;
               background-size: cover; color: #fff; }
        nav { background: rgba(0,0,0,0.7); padding:10px; display:flex; justify-content:center; gap:20px; }
        nav a { color:#f39c12; text-decoration:none; font-weight:bold; }
        nav a.active, nav a:hover { color:#ffd700; }
        .container { max-width: 95%; margin: 20px auto; background: rgba(0,0,0,0.6);
                     padding:20px; border-radius:12px; box-shadow:0 0 20px rgba(255,165,0,0.5); }
        h1 { font-size:2em; color:#f39c12; text-shadow:2px 2px 8px #000; }
        .flex { display:flex; flex-wrap:wrap; gap:20px; }
        .table-wrapper { flex:2 1 600px; max-height:500px; overflow:auto; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:8px; border:1px solid #444; text-align:center; }
        thead { position:sticky; top:0; background:#f39c12; color:#000; }
        .mvp-wrapper { flex:1 1 200px; background:rgba(0,0,0,0.8); padding:10px; border-radius:8px;
                       max-height:500px; overflow:auto; }
        .mvp-wrapper h2 { margin-top:0; color:#f39c12; }
        .search { margin:10px 0; }
        .search input { padding:8px; border:none; border-radius:5px; width:200px; }
        .btn { background:#f39c12; color:#000; border:none; padding:10px 16px; cursor:pointer;
               border-radius:5px; font-weight:bold; }
        .hidden { display:none; }
        @media(max-width:768px) { .flex { flex-direction:column; } }
    </style>
    <!-- Papa Parse CDN -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
<nav>
  <a href="index.html">–ú–æ–ª–æ–¥—à–∞ –õ—ñ–≥–∞</a>
  <a href="sunday.html" class="active">–°—Ç–∞—Ä—à–∞ –õ—ñ–≥–∞</a>
  <a href="rules.html">–ü—Ä–∞–≤–∏–ª–∞</a>
  <a href="about.html">–ü—Ä–æ –∫–ª—É–±</a>
</nav>
<div class="container">
  <h1>–°—Ç–∞—Ä—à–∞ –õ—ñ–≥–∞ | –†–µ–π—Ç–∏–Ω–≥ –≥—Ä–∞–≤—Ü—ñ–≤</h1>
  <p>‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∏–π —Å–µ–∑–æ–Ω. –î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</p>

  <div class="search">
    <input id="search" type="text" placeholder="–ü–æ—à—É–∫ –Ω—ñ–∫–Ω–µ–π–º—É..." oninput="filterRows()">
  </div>

  <div class="flex">
    <!-- Main Ranking -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>–ú—ñ—Å—Ü–µ</th><th>–ù—ñ–∫–Ω–µ–π–º</th><th>–†–∞–Ω–≥</th><th>–ë–∞–ª–∏</th>
            <th>–Ü–≥–æ—Ä</th><th>–ü–µ—Ä–µ–º–æ–≥</th><th>–ü–æ—Ä–∞–∑–æ–∫</th><th>WinRate (%)</th><th>MVP</th>
          </tr>
        </thead>
        <tbody id="main-table"></tbody>
      </table>
      <button class="btn" id="toggle-btn" onclick="toggleMore()">–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ</button>
    </div>
    <!-- Top MVP -->
    <div class="mvp-wrapper">
      <h2>–¢–æ–ø 3 MVP</h2>
      <table>
        <thead><tr><th>–ù—ñ–∫–Ω–µ–π–º</th><th>MVP</th></tr></thead>
        <tbody id="mvp-table"></tbody>
      </table>
    </div>
  </div>
</div>
<script>
// URLs: publish 'sunday' sheet and 'games' sheet separately to CSV
const rankingURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzum1H-NSUejvB_XMMWaTs04SPz7SQGpKkyFwz4NQjsN8hz2jAFAhl-jtRdYVAXgr36sN4RSoQSpEN/pub?gid=1286735969&single=true&output=csv";
const gamesURL   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzum1H-NSUejvB_XMMWaTs04SPz7SQGpKkyFwz4NQjsN8hz2jAFAhl-jtRdYVAXgr36sN4RSoQSpEN/pubhtml?gid=249347260&single=true";
let allRows = [];

// Utility: assign rank icon based on points
function getRank(p) {
  if (p>=1200) return {rank:'S',icon:'üü£'};
  if (p>=800)  return {rank:'A',icon:'üî¥'};
  if (p>=500)  return {rank:'B',icon:'üü°'};
  if (p>=200)  return {rank:'C',icon:'üîµ'};
  return              {rank:'D',icon:'üü¢'};
}

// Load and merge data
function loadData(){
  let rankData;
  Papa.parse(rankingURL, {
    download:true, header:true, complete: (r1)=>{
      rankData = r1.data;
      Papa.parse(gamesURL, {
        download:true, header:true, complete: (r2)=>{
          const games = r2.data;
          const stats = {};
          // aggregate only sunday league
          games.forEach(g=>{
            if (g.League!=='sunday') return;
            const t1 = g.Team1.split(',').map(s=>s.trim().split(' (')[0]);
            const t2 = g.Team2.split(',').map(s=>s.trim().split(' (')[0]);
            let win=[], lose=[];
            if (g.Winner==='team1') win=t1, lose=t2;
            else if (g.Winner==='team2') win=t2, lose=t1;
            else if (t1.includes(g.Winner)) win=t1, lose=t2;
            else if (t2.includes(g.Winner)) win=t2, lose=t1;
            t1.concat(t2).forEach(p=>{
              if (!p) return;
              if (!stats[p]) stats[p]={games:0,wins:0,losses:0,mvp:0};
              stats[p].games++;
            });
            win.forEach(p=>stats[p].wins++);
            lose.forEach(p=>stats[p].losses++);
            if (g.MVP && stats[g.MVP]) stats[g.MVP].mvp++;
          });
          // merge aliases
          const aliases={'Mariko':'Gidora','Zavodchanyn':'Romario','Timabuilding':'–ë–æ–π–±—É–¥'};
          Object.entries(aliases).forEach(([old,newn])=>{
            if(stats[old]){
              stats[newn]=stats[newn]||{games:0,wins:0,losses:0,mvp:0};
              ['games','wins','losses','mvp'].forEach(k=>stats[newn][k]+=stats[old][k]);
              delete stats[old];
            }
          });
          // combine ranking & stats
          const players = rankData.map(p=>({
            nickname:p.–ù—ñ–∫–Ω–µ–π–º, points:+p.–ë–∞–ª–∏ || 0,
            games:stats[p.–ù—ñ–∫–Ω–µ–π–º]?.games||0,
            wins: stats[p.–ù—ñ–∫–Ω–µ–π–º]?.wins||0,
            losses:stats[p.–ù—ñ–∫–Ω–µ–π–º]?.losses||0,
            mvp:   stats[p.–ù—ñ–∫–Ω–µ–π–º]?.mvp||0
          }));
          renderTables(players);
        }
      });
    }
  });
}

// Render main and MVP tables
function renderTables(players){
  // main
  players.sort((a,b)=>b.points-a.points);
  const mt= document.getElementById('main-table'); mt.innerHTML=''; allRows=[];
  players.forEach((p,i)=>{
    const {rank,icon}=getRank(p.points);
    const row=document.createElement('tr');
    row.innerHTML=`<td>${i+1}</td><td>${icon} ${p.nickname}</td>
      <td>${rank}</td><td>${p.points}</td>
      <td>${p.games}</td><td>${p.wins}</td>
      <td>${p.losses}</td><td>${p.games?((p.wins/p.games)*100).toFixed(2):'0.00'}</td>
      <td>${p.mvp}</td>`;
    if(i>=10) row.classList.add('hidden');
    mt.appendChild(row);
    allRows.push(row);
  });
  // MVP top3
  const mv= document.getElementById('mvp-table'); mv.innerHTML='';
  players.sort((a,b)=>b.mvp-a.mvp).slice(0,3)
    .forEach(p=>{ mv.innerHTML+=`<tr><td>${p.nickname}</td><td>${p.mvp}</td></tr>`; });
}

// Search and toggle
function filterRows(){
  const q=document.getElementById('search').value.toLowerCase();
  allRows.forEach((r,i)=>{
    r.style.display = q? r.children[1].textContent.toLowerCase().includes(q)?'table-row':'none' : i<10?'table-row':'none';
  });
  document.getElementById('toggle-btn').textContent = q?'–ü–æ–∫–∞–∑–∞—Ç–∏ –¢–æ–ø-10':'–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ';
}
function toggleMore(){
  const btn=document.getElementById('toggle-btn');
  const showAll = btn.textContent==='–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ';
  allRows.forEach((r,i)=>{ if(i>=10) r.style.display= showAll?'table-row':'none'; });
  btn.textContent= showAll?'–ü–æ–∫–∞–∑–∞—Ç–∏ –¢–æ–ø-10':'–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ';
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
