<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Старша ліга | Лазертаг</title>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin:0; padding:0;
               background: url('assets/backgr.jpg') no-repeat center center fixed;
               background-size: cover; color: #fff; }
        nav { background: rgba(0,0,0,0.7); padding:10px; display:flex; justify-content:center; gap:20px; }
        nav a { color:#f39c12; text-decoration:none; font-weight:bold; }
        nav a.active, nav a:hover { color:#ffd700; border-bottom:2px solid #ffd700; }
        .container { max-width:95%; margin:20px auto; background:rgba(0,0,0,0.7);
                     padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(255,165,0,0.5); }
        h1 { color:#f39c12; text-shadow:2px 2px 8px black; }
        .search-box { margin:15px 0; }
        .search-box input { padding:8px; border:none; border-radius:5px; width:100%; max-width:300px; }
        .stats-grid { display:grid; gap:20px; grid-template-columns:1fr; }
        @media(min-width:900px) { .stats-grid { grid-template-columns:2fr 1fr; } }
        table { width:100%; border-collapse:collapse; background:rgba(26,26,26,0.9); }
        th, td { padding:8px; border:1px solid #444; text-align:center; font-size:0.9em; }
        thead th { position:sticky; top:0; background:#f39c12; color:black; z-index:1; }
        .show-more { margin-top:10px; padding:10px; background:#f39c12; color:black;
                     border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .hidden { display:none; }
    </style>
</head>
<body>
<nav>
    <a href="index.html" id="nav-kids">Молодша Ліга</a>
    <a href="sunday.html" id="nav-sunday" class="active">Старша Ліга</a>
    <a href="rules.html" id="nav-rules">Правила</a>
    <a href="about.html" id="nav-about">Про клуб</a>
</nav>
<div class="container">
    <h1>Старша ліга | Рейтинг гравців</h1>
    <p>⚠️ Тестовий сезон. Дані динамічні.</p>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Пошук нікнейму..." oninput="filterTable()" />
    </div>

    <div class="stats-grid">
        <!-- Main Ranking -->
        <div>
            <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Нік</th>
                        <th>Ранг</th>
                        <th>Бали</th>
                        <th>Ігор</th>
                        <th>Перемог</th>
                        <th>Поразок</th>
                        <th>Бої</th>
                        <th>Вигр.боїв</th>
                        <th>Прогр.боїв</th>
                        <th>WinRate %</th>
                        <th>MVP</th>
                    </tr>
                </thead>
                <tbody id="ranking-table"></tbody>
            </table>
            </div>
            <button class="show-more" onclick="togglePlayers()">Показати більше</button>
        </div>
        <!-- Top MVP -->
        <div>
            <h2>Топ 3 MVP</h2>
            <table>
                <thead><tr><th>Нік</th><th>MVP</th></tr></thead>
                <tbody id="top-mvp-table"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const rankingURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzum1H-NSUejvB_XMMWaTs04SPz7SQGpKkyFwz4NQjsN8hz2jAFAhl-jtRdYVAXgr36sN4RSoQSpEN/pub?gid=1286735969&single=true&output=csv";
const gamesURL   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzum1H-NSUejvB_XMMWaTs04SPz7SQGpKkyFwz4NQjsN8hz2jAFAhl-jtRdYVAXgr36sN4RSoQSpEN/pub?gid=249347260&single=true&output=csv"; // вставити gid аркуша games
let allRows = [];

async function loadData() {
    // Завантажуємо рейтинг
    const rText = await fetch(rankingURL).then(r=>r.text());
    const rankData = Papa.parse(rText, {header:true, skipEmptyLines:true}).data;
    // Завантажуємо ігри
    const gText = await fetch(gamesURL).then(r=>r.text());
    const games = Papa.parse(gText, {header:true, skipEmptyLines:true}).data;
    // Фільтр для Sunday
    const sunday = games.filter(g=>g.League.trim().toLowerCase()==='sunday');
    // Підготовка статистики
    const stats = {};
    rankData.forEach(r=>{ stats[r.Nickname]={games:0,wins:0,losses:0,mvp:0,battles:0,battleWins:0,battleLosses:0}; });
    sunday.forEach(g=>{
        const t1 = g.Team1.split(',').map(x=>x.trim()),
              t2 = g.Team2.split(',').map(x=>x.trim());
        const [b1,b2] = g.Series.split('-').map(n=>parseInt(n,10));
        // визначаємо хто переміг у матчі
        let winSet = [], loseSet = [];
        if (b1 > b2) { winSet = t1; loseSet = t2; }
        else if (b2 > b1) { winSet = t2; loseSet = t1; }
        // оновлюємо stats
        t1.concat(t2).forEach(n=>{ if(!stats[n]) stats[n]={games:0,wins:0,losses:0,mvp:0,battles:0,battleWins:0,battleLosses:0}; stats[n].games++; stats[n].battles += b1+b2; });
        winSet.forEach(n=>{ stats[n].wins++; stats[n].battleWins += (winSet===t1?b1:b2); });
        loseSet.forEach(n=> stats[n].losses++);
        loseSet.forEach(n=> stats[n].battleLosses += (loseSet===t1?b1:b2));
        if (stats[g.MVP]) stats[g.MVP].mvp++;
    });
    // Збірка фінального масиву
    const players = rankData.map((r,i)=>{
        const s = stats[r.Nickname]||{games:0,wins:0,losses:0,mvp:0,battles:0,battleWins:0,battleLosses:0};
        const winRate = s.games>0?((s.wins/s.games*100).toFixed(2)):'0.00';
        return { place:i+1, nickname:r.Nickname, points:+r.Points,
                 games:s.games,wins:s.wins,losses:s.losses,
                 battles:s.battles,battleWins:s.battleWins,battleLosses:s.battleLosses,
                 winRate, mvp:s.mvp };
    });
    renderRanking(players);
    renderTopMVP(players);
}

function renderRanking(players) {
    const sorted = players.sort((a,b)=>b.points - a.points);
    const tbody = document.getElementById('ranking-table'); tbody.innerHTML=''; allRows=[];
    sorted.forEach((p,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.place}</td><td>${p.nickname}</td><td>${p.points}</td>
                      <td>${p.games}</td><td>${p.wins}</td><td>${p.losses}</td>
                      <td>${p.battles}</td><td>${p.battleWins}</td>
                      <td>${p.battleLosses}</td><td>${p.winRate}</td><td>${p.mvp}</td>`;
        if(i>=10) tr.classList.add('hidden');
        tbody.appendChild(tr); allRows.push(tr);
    });
}

function renderTopMVP(players) {
    const top=players.sort((a,b)=>b.mvp-a.mvp).slice(0,3);
    const tbody = document.getElementById('top-mvp-table'); tbody.innerHTML='';
    top.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.nickname}</td><td>${p.mvp}</td>`; tbody.appendChild(tr); });
}

function filterTable() {
    const q=document.getElementById('searchInput').value.toLowerCase();
    allRows.forEach((r,i)=>{
        const show = r.textContent.toLowerCase().includes(q) && (q||i<10);
        r.style.display=show?'table-row':'none';
    });
}

function togglePlayers(){ const show=allRows[10]?.classList.toggle('hidden'); }

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
