<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaserTag v2</title>
  <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">üéÆ LaserTag v2</div>
    <a class="nav-link" href="./season.html">üèÜ Seasons</a>
  </header>
  <main>
    <section class="card">
      <h1 class="section-title">–ì–æ–ª–æ–≤–Ω–∞</h1>
      <p class="tag" id="currentSeason">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
      <div class="hero-grid" id="topHeroes"></div>
      <div class="kpi kpi-2" id="overviewStats"></div>
      <div class="kpi kpi-2" id="charts"></div>
      <p class="tag" id="stateBox"></p>
    </section>

    <section class="menu-grid">
      <a class="menu-btn" href="./gameday.html">‚ñ∂ Game Day</a>
      <a class="menu-btn" href="./season.html">üèÜ Season</a>
      <a class="menu-btn" href="./league.html?league=kids">üë• Leagues</a>
      <a class="menu-btn" href="./rules.html">üìú Rules</a>
    </section>
  </main>

  <script type="module">
    import { getHomeOverview, safeErrorMessage, rankMeta } from '../core/dataHub.js';

    const placeholder = '../assets/default-avatar.svg';
    const ranks = ['S', 'A', 'B', 'C', 'D', 'E', 'F'];

    function heroCard(player, leagueLabel) {
      if (!player) return `<article class="card mini"><p class="tag">${leagueLabel}</p><p>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</p></article>`;
      const meta = rankMeta(player.rankLetter);
      return `<article class="hero-card ${meta.cssClass}">
        <p class="tag">Top-1 ${leagueLabel}</p>
        <div class="player-head">
          <img class="avatar lg" src="${player.avatarUrl || placeholder}" alt="avatar" onerror="this.src='${placeholder}'">
          <div>
            <h3>${player.nick}</h3>
            <p><span class="rank-badge ${meta.cssClass}">${meta.label}</span></p>
            <p class="tag">Points: ${player.points ?? '‚Äî'} ¬∑ MVP: ${player.mvp ?? 0}</p>
          </div>
        </div>
      </article>`;
    }

    function statsCard(title, stats) {
      return `<article class="card mini"><p class="tag">${title}</p><h3>–Ü–≥—Ä–∏: ${stats.games}</h3><p>–†–∞—É–Ω–¥–∏: ${stats.rounds}</p></article>`;
    }

    function distChart(title, dist) {
      const total = Object.values(dist || {}).reduce((a, b) => a + b, 0) || 1;
      const bars = ranks.map((r) => {
        const v = dist?.[r] || 0;
        const width = Math.round((v / total) * 100);
        const meta = rankMeta(r);
        return `<div class="dist-row"><span>${r}</span><div class="dist-track"><div class="dist-fill ${meta.cssClass}" style="width:${width}%"></div></div><b>${v}</b></div>`;
      }).join('');
      return `<article class="card mini"><p class="tag">${title}</p>${bars}</article>`;
    }

    async function init() {
      const stateBox = document.getElementById('stateBox');
      try {
        stateBox.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        const data = await getHomeOverview();
        document.getElementById('currentSeason').textContent = data.seasonTitle;
        document.getElementById('topHeroes').innerHTML = heroCard(data.top1Kids, 'Kids') + heroCard(data.top1Adults, 'Sundaygames');
        document.getElementById('overviewStats').innerHTML = statsCard('Kids —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', data.statsKids) + statsCard('Sundaygames —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', data.statsAdults);
        document.getElementById('charts').innerHTML = distChart('–†–æ–∑–ø–æ–¥—ñ–ª —Ä–∞–Ω–≥—É: Kids', data.rankDistKids) + distChart('–†–æ–∑–ø–æ–¥—ñ–ª —Ä–∞–Ω–≥—É: Sundaygames', data.rankDistAdults);
        stateBox.textContent = '';
      } catch (error) {
        document.getElementById('currentSeason').textContent = '–ü–æ–º–∏–ª–∫–∞';
        stateBox.textContent = safeErrorMessage(error);
      }
    }

    init();
  </script>
</body>
</html>
