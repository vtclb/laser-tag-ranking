<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile | v2</title>
  <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Player Profile</div>
    <a class="nav-link" href="./league.html">League</a>
  </header>
  <main id="content"></main>

  <script type="module">
    import { getPlayerProfile, safeErrorMessage } from '../core/dataHub.js';
    import { getQueryParams, statOrDash } from '../core/utils.js';

    const { nick = '', league = 'kids' } = getQueryParams();
    const content = document.getElementById('content');
    const placeholder = '../assets/default-avatar.svg';

    function renderList(items, metric) {
      if (!items?.length) return '<li>—</li>';
      return items.map((item) => `<li>${item.nick} (${item[metric]})</li>`).join('');
    }

    async function init() {
      if (!nick) {
        content.innerHTML = '<section class="card"><h1>Player not found</h1></section>';
        return;
      }

      try {
        const profile = await getPlayerProfile({ nick, league });
        if (!profile) {
          content.innerHTML = '<section class="card"><h1>Player not found</h1></section>';
          return;
        }

        const rank = profile.current?.rank || 'F';
        document.body.classList.add(`rank-${rank}`);
        const games = profile.allTime.games || 0;

        content.innerHTML = `
          <section class="card profile-header rank-theme-${rank}">
            <div class="player-head">
              <img class="avatar lg" src="${profile.avatarUrl || placeholder}" alt="avatar" onerror="this.src='${placeholder}'">
              <div>
                <h1 class="section-title">${profile.nick}</h1>
                <p class="tag">Rank: <span class="rank-badge rank-${rank}">${rank}</span> · Points: ${statOrDash(profile.current?.points)}</p>
                <p class="tag">Ліга: ${profile.current?.league || '—'}</p>
              </div>
            </div>
            <div class="progress-shell"><div class="progress-bar" style="width:${Math.min(100, (profile.current?.points || 0) % 200 / 2)}%"></div></div>
          </section>

          <section class="kpi kpi-5">
            <article class="card"><p class="tag">Points</p><h3>${statOrDash(profile.current?.points)}</h3></article>
            <article class="card"><p class="tag">Games</p><h3>${games}</h3></article>
            <article class="card"><p class="tag">Winrate</p><h3>${statOrDash(profile.allTime.winRate)}%</h3></article>
            <article class="card"><p class="tag">MVP</p><h3>${profile.allTime.mvp}</h3></article>
            <article class="card"><p class="tag">Top2 / Top3</p><h3>${profile.allTime.top2} / ${profile.allTime.top3}</h3></article>
          </section>

          <section class="card">
            <h2>All-time</h2>
            <p class="tag">W/L/D: ${profile.allTime.wins}/${profile.allTime.losses}/${profile.allTime.draws}</p>
          </section>

          <section class="card">
            <h2>По сезонах</h2>
            <ul class="list-clean">
              ${profile.seasons.map((item) => `<li><strong>${item.seasonTitle}</strong> — games: ${item.games}, W/L/D: ${item.wins}/${item.losses}/${item.draws}, MVP/Top2/Top3: ${item.mvp}/${item.top2}/${item.top3}</li>`).join('')}
            </ul>
          </section>

          <section class="profile-grid two-col">
            <article class="card"><h3>Найчастіше в команді з</h3><p class="tag">Winrate з ним: ${statOrDash(profile.insights.teammateWinrate)}%</p><ul class="list-clean">${renderList(profile.insights.topTeammates, 'gamesTogether')}</ul></article>
            <article class="card"><h3>Найчастіше проти</h3><p class="tag">Winrate проти нього: ${statOrDash(profile.insights.versusWinrate)}%</p><ul class="list-clean">${renderList(profile.insights.topOpponents, 'gamesAgainst')}</ul></article>
          </section>
        `;
      } catch (error) {
        content.innerHTML = `<section class="card"><h1>Не вдалося завантажити дані</h1><p>${safeErrorMessage(error)}</p></section>`;
      }
    }

    init();
  </script>
</body>
</html>
