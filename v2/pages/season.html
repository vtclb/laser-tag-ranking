<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seasons | v2</title>
  <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Сезони</div>
    <a class="nav-link" href="./index.html">Menu</a>
  </header>
  <main>
    <section class="card">
      <h1 class="section-title">Season view</h1>
      <div class="search-row">
        <select id="seasonSelect" class="search-input"></select>
        <select id="leagueSelect" class="search-input">
          <option value="kids">Молодша</option>
          <option value="sundaygames">Старша</option>
        </select>
      </div>
      <p class="tag" id="seasonTitle"></p>
      <div class="top3" id="top3"></div>
      <p class="tag" id="errorBox"></p>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th>Nick</th><th>Pts</th><th>Games</th><th>WinRate</th><th>MVP</th><th>Top2</th><th>Top3</th><th>Rank</th></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>
  <script type="module">
    import { getLeagueSnapshot, getSeasonOverview, loadSeasonsConfig, normalizeLeague, safeErrorMessage } from '../core/dataHub.js';
    import { getQueryParams, createTop3Markup, statOrDash } from '../core/utils.js';

    const query = getQueryParams();
    const seasonSelect = document.getElementById('seasonSelect');
    const leagueSelect = document.getElementById('leagueSelect');

    function renderRows(rows) {
      document.getElementById('tableBody').innerHTML = rows.map((player) => `
        <tr>
          <td>${player.place}</td>
          <td>${player.nick}</td>
          <td>${statOrDash(player.points)}</td>
          <td>${statOrDash(player.games)}</td>
          <td>${player.winRate === null || player.winRate === 0 ? '—' : `${player.winRate}%`}</td>
          <td>${statOrDash(player.mvp)}</td>
          <td>${statOrDash(player.mvp2)}</td>
          <td>${statOrDash(player.mvp3)}</td>
          <td><span class="rank-badge rank-${player.rankLetter}">${player.rankLetter}</span></td>
        </tr>
      `).join('') || '<tr><td colspan="9">Дані відсутні</td></tr>';
    }

    async function loadSnapshot() {
      const seasonId = seasonSelect.value;
      const league = normalizeLeague(leagueSelect.value) || 'kids';
      const [snapshot, overview] = await Promise.all([
        getLeagueSnapshot({ seasonId, league }),
        getSeasonOverview({ seasonId })
      ]);
      document.getElementById('seasonTitle').textContent = `${snapshot.seasonTitle} · ${league === 'kids' ? 'Молодша' : 'Старша'} · Top10: ${(overview.top10[league] || []).length}`;
      document.getElementById('top3').innerHTML = createTop3Markup(snapshot.top3);
      renderRows(snapshot.table);

      const url = new URL(window.location.href);
      url.searchParams.set('season', seasonId);
      url.searchParams.set('league', league);
      history.replaceState({}, '', url);
    }

    async function init() {
      const cfg = await loadSeasonsConfig();
      const enabled = cfg.seasons.filter((s) => s.enabled !== false);
      seasonSelect.innerHTML = enabled.map((s) => `<option value="${s.id}">${s.uiLabel}</option>`).join('');
      seasonSelect.value = query.seasonId && enabled.some((s) => s.id === query.seasonId) ? query.seasonId : cfg.currentSeasonId;
      leagueSelect.value = normalizeLeague(query.league) || 'kids';
      await loadSnapshot();
    }

    seasonSelect.addEventListener('change', () => { loadSnapshot(); });
    leagueSelect.addEventListener('change', () => { loadSnapshot(); });

    init().catch((error) => {
      document.getElementById('seasonTitle').textContent = 'Не вдалося завантажити дані';
      document.getElementById('errorBox').textContent = safeErrorMessage(error);
    });
  </script>
</body>
</html>
