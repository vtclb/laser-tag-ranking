<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seasons | v2</title>
  <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">–°–µ–∑–æ–Ω–∏</div>
    <a class="nav-link" href="./index.html">Menu</a>
  </header>
  <main>
    <section class="card">
      <div class="search-row">
        <select id="seasonSelect" class="search-input"></select>
        <select id="leagueSelect" class="search-input">
          <option value="kids">kids</option>
          <option value="sundaygames">sundaygames</option>
        </select>
      </div>
      <h1 class="section-title" id="seasonTitle">‚Äî</h1>
      <div class="kpi kpi-2" id="totals"></div>
      <div class="kpi kpi-2" id="charts"></div>
      <div class="top3" id="top3"></div>
      <div class="kpi kpi-2" id="leaders"></div>
      <p class="tag" id="state"></p>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th>Nick</th><th>Pts</th><th>Games</th><th>Winrate</th><th>Top1</th><th>Top2</th><th>Top3</th></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <dialog id="playerModal" class="player-modal">
    <article class="card modal-card" id="modalBody"></article>
  </dialog>

  <script type="module">
    import { getSeasonsList, getSeasonDashboard, getSeasonPlayerQuickCard, rankMeta, safeErrorMessage } from '../core/dataHub.js';

    const seasonSelect = document.getElementById('seasonSelect');
    const leagueSelect = document.getElementById('leagueSelect');
    const modal = document.getElementById('playerModal');
    const modalBody = document.getElementById('modalBody');
    const placeholder = '../assets/default-avatar.svg';

    function distChart(dist) {
      return ['S','A','B','C','D','E','F'].map((r) => {
        const meta = rankMeta(r);
        return `<div class="dist-row"><span>${r}</span><div class="dist-track"><div class="dist-fill ${meta.cssClass}" style="width:${(dist[r] || 0) * 8}%"></div></div><b>${dist[r] || 0}</b></div>`;
      }).join('');
    }

    function renderRows(rows) {
      document.getElementById('tableBody').innerHTML = rows.map((p) => `
        <tr data-nick="${p.nick}">
          <td>${p.place}</td>
          <td><button class="chip player-btn" data-nick="${p.nick}">${p.nick}</button></td>
          <td>${p.points ?? '‚Äî'}</td><td>${p.games}</td><td>${p.winRate ?? '‚Äî'}%</td><td>${p.mvp}</td><td>${p.mvp2}</td><td>${p.mvp3}</td>
        </tr>
      `).join('') || '<tr><td colspan="8">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</td></tr>';
    }

    async function showPlayer(nick) {
      const data = await getSeasonPlayerQuickCard({ seasonId: seasonSelect.value, league: leagueSelect.value, nick });
      if (!data) return;
      modalBody.innerHTML = `
        <button class="chip modal-close" onclick="document.getElementById('playerModal').close()">‚úï</button>
        <div class="player-head">
          <img class="avatar lg" src="${data.avatarUrl || placeholder}" alt="avatar" onerror="this.src='${placeholder}'">
          <div><h3>${data.nick}</h3><p><span class="rank-badge ${data.rank.cssClass}">${data.rank.label}</span> ¬∑ points: ${data.points ?? '‚Äî'}</p></div>
        </div>
        <p>W/L/D: ${data.wins}/${data.losses}/${data.draws} ¬∑ WR: ${data.winrate ?? '‚Äî'}%</p>
        <p>Top1/2/3: ${data.mvp1}/${data.mvp2}/${data.mvp3}</p>
        <div class="modal-actions"><a class="chip" href="./profile.html?nick=${encodeURIComponent(data.nick)}">–ü—Ä–æ—Ñ—ñ–ª—å</a></div>
      `;
      modal.showModal();
    }

    async function loadDashboard() {
      const state = document.getElementById('state');
      try {
        state.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        const data = await getSeasonDashboard(seasonSelect.value, leagueSelect.value);
        document.getElementById('seasonTitle').textContent = `${data.seasonTitle} ¬∑ ${data.league}`;
        document.getElementById('totals').innerHTML = `<article class="card mini"><h3>Games ${data.totals.games}</h3><p>Rounds ${data.totals.rounds}</p></article><article class="card mini"><h3>Players ${data.totals.players}</h3><p>AVG ${data.totals.avgGamesPerPlayer}</p></article>`;
        document.getElementById('charts').innerHTML = `<article class="card mini"><p class="tag">Rank distribution</p>${distChart(data.rankDistribution)}</article>`;
        document.getElementById('top3').innerHTML = data.top3.map((p) => `<article class="top-card"><img class="avatar" src="${p.avatarUrl || placeholder}" onerror="this.src='${placeholder}'"> ${p.nick}<br><span class="rank-badge ${p.rank.cssClass}">${p.rank.label}</span></article>`).join('');
        document.getElementById('leaders').innerHTML = `<article class="card mini">ü•á –ì—Ä—ñ–Ω–¥–µ—Ä: ${data.leaders.mostGames.nick || '‚Äî'} (${data.leaders.mostGames.count || 0})</article><article class="card mini">üéØ –°–Ω–∞–π–ø–µ—Ä: ${data.leaders.bestWinrate.nick || '‚Äî'} (${data.leaders.bestWinrate.winRate || 0}%)</article><article class="card mini">üëë Top1: ${data.leaders.mostTop1.nick || '‚Äî'}</article><article class="card mini">ü•à Top2: ${data.leaders.mostTop2.nick || '‚Äî'}</article><article class="card mini">ü•â Top3: ${data.leaders.mostTop3.nick || '‚Äî'}</article>`;
        renderRows(data.tablePlayers);
        state.textContent = '';
      } catch (error) {
        state.textContent = safeErrorMessage(error);
      }
    }

    document.getElementById('tableBody').addEventListener('click', (event) => {
      const btn = event.target.closest('.player-btn');
      if (btn) showPlayer(btn.dataset.nick);
    });

    async function init() {
      const seasons = await getSeasonsList();
      seasonSelect.innerHTML = seasons.map((s) => `<option value="${s.id}">${s.title}</option>`).join('');
      seasonSelect.value = seasons[0]?.id;
      seasonSelect.addEventListener('change', loadDashboard);
      leagueSelect.addEventListener('change', loadDashboard);
      await loadDashboard();
    }

    init();
  </script>
</body>
</html>
